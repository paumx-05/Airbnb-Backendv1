import { test, expect } from '@playwright/test';

/**
 * Test del flujo COMPLETO de cambio de contrase√±a:
 * 1. Ir a /forgot-password
 * 2. Enviar email para solicitar token
 * 3. Simular recibir token
 * 4. Cambiar contrase√±a con el token
 */

test.describe('Flujo Completo de Cambio de Contrase√±a', () => {
  test('Probar flujo completo: forgot-password -> reset-password', async ({ page }) => {
    console.log('üîç [COMPLETE FLOW] Iniciando test del flujo completo...');
    
    // Capturar logs de consola
    const consoleLogs: string[] = [];
    page.on('console', msg => {
      consoleLogs.push(`[${msg.type()}] ${msg.text()}`);
    });
    
    // Capturar errores de red
    const networkErrors: string[] = [];
    page.on('response', response => {
      if (!response.ok()) {
        networkErrors.push(`[NETWORK ERROR] ${response.status()} - ${response.url()}`);
      }
    });
    
    // Paso 1: Limpiar storage
    await page.goto('http://localhost:3000');
    await page.evaluate(() => {
      localStorage.clear();
      sessionStorage.clear();
    });
    
    // Paso 2: Ir directamente a /forgot-password
    console.log('üîç [COMPLETE FLOW] Navegando a /forgot-password...');
    await page.goto('http://localhost:3000/forgot-password');
    await page.waitForLoadState('networkidle');
    
    // Verificar que estamos en la p√°gina correcta
    const pageTitle = await page.locator('h1').textContent();
    console.log('üîç [COMPLETE FLOW] T√≠tulo de la p√°gina:', pageTitle);
    
    // Paso 3: Buscar formulario de forgot-password
    console.log('üîç [COMPLETE FLOW] Buscando formulario de forgot-password...');
    
    const emailInputs = await page.locator('input[type="email"]').count();
    const forms = await page.locator('form').count();
    const submitButtons = await page.locator('button[type="submit"]').count();
    
    console.log('üîç [COMPLETE FLOW] Elementos encontrados:');
    console.log('  - Campos de email:', emailInputs);
    console.log('  - Formularios:', forms);
    console.log('  - Botones de env√≠o:', submitButtons);
    
    if (emailInputs > 0 && submitButtons > 0) {
      console.log('‚úÖ [COMPLETE FLOW] Formulario encontrado, llenando...');
      
      // Llenar email
      await page.locator('input[type="email"]').first().fill('jose1@gmail.com');
      console.log('üîç [COMPLETE FLOW] Email llenado: jose1@gmail.com');
      
      // Enviar formulario
      await page.locator('button[type="submit"]').first().click();
      console.log('üîç [COMPLETE FLOW] Formulario enviado');
      
      // Esperar respuesta (con timeout m√°s largo)
      await page.waitForTimeout(5000);
      
      // Verificar respuesta
      const successMessage = await page.locator('.text-green-400').textContent();
      const errorMessage = await page.locator('.text-red-400').textContent();
      const checkCircle = await page.locator('.text-green-500').count();
      
      console.log('üîç [COMPLETE FLOW] Respuesta del env√≠o:');
      console.log('  - Mensaje de √©xito:', successMessage);
      console.log('  - Mensaje de error:', errorMessage);
      console.log('  - √çcono de √©xito:', checkCircle);
      
      // Paso 4: Si hay √©xito, buscar formulario de cambio de contrase√±a
      if (successMessage || checkCircle > 0 || !errorMessage) {
        console.log('‚úÖ [COMPLETE FLOW] Email enviado exitosamente');
        
        // Buscar si hay un formulario de cambio de contrase√±a en la misma p√°gina
        const passwordInputs = await page.locator('input[type="password"]').count();
        console.log('üîç [COMPLETE FLOW] Campos de contrase√±a en la p√°gina:', passwordInputs);
        
        if (passwordInputs > 0) {
          console.log('‚úÖ [COMPLETE FLOW] Formulario de cambio de contrase√±a encontrado');
          
          // Buscar campos espec√≠ficos
          const newPasswordField = page.locator('input[id="new-password"]');
          const confirmPasswordField = page.locator('input[id="confirm-password"]');
          
          const newPasswordExists = await newPasswordField.count();
          const confirmPasswordExists = await confirmPasswordField.count();
          
          console.log('üîç [COMPLETE FLOW] Campos espec√≠ficos:');
          console.log('  - Nueva contrase√±a:', newPasswordExists);
          console.log('  - Confirmar contrase√±a:', confirmPasswordExists);
          
          if (newPasswordExists > 0 && confirmPasswordExists > 0) {
            // Llenar nueva contrase√±a
            await newPasswordField.fill('nueva123456');
            await confirmPasswordField.fill('nueva123456');
            
            console.log('üîç [COMPLETE FLOW] Nueva contrase√±a llenada');
            
            // Enviar formulario
            const submitButton = page.locator('button[type="submit"]');
            await submitButton.click();
            
            console.log('üîç [COMPLETE FLOW] Formulario de cambio enviado');
            
            // Esperar respuesta
            await page.waitForTimeout(3000);
            
            // Verificar resultado final
            const finalSuccessMessage = await page.locator('.text-green-400').textContent();
            const finalErrorMessage = await page.locator('.text-red-400').textContent();
            
            console.log('üîç [COMPLETE FLOW] Resultado final:');
            console.log('  - Mensaje de √©xito:', finalSuccessMessage);
            console.log('  - Mensaje de error:', finalErrorMessage);
            
            // Verificar si hay error de token
            if (finalErrorMessage && (finalErrorMessage.includes('token') || finalErrorMessage.includes('inv√°lido') || finalErrorMessage.includes('expirado'))) {
              console.log('‚ùå [COMPLETE FLOW] ERROR DE TOKEN DETECTADO:', finalErrorMessage);
            } else if (finalSuccessMessage) {
              console.log('‚úÖ [COMPLETE FLOW] CAMBIO DE CONTRASE√ëA EXITOSO:', finalSuccessMessage);
            }
          }
        } else {
          console.log('üîç [COMPLETE FLOW] No hay formulario de cambio de contrase√±a en esta p√°gina');
          
          // Buscar enlaces o botones que puedan llevar al cambio de contrase√±a
          const links = await page.locator('a').count();
          const buttons = await page.locator('button').count();
          
          console.log('üîç [COMPLETE FLOW] Elementos interactivos:');
          console.log('  - Enlaces:', links);
          console.log('  - Botones:', buttons);
          
          // Obtener texto de todos los enlaces
          const linkTexts = await page.locator('a').allTextContents();
          console.log('üîç [COMPLETE FLOW] Textos de enlaces:');
          linkTexts.forEach((text, index) => {
            if (text.toLowerCase().includes('contrase√±a') || text.toLowerCase().includes('password') || text.toLowerCase().includes('reset')) {
              console.log(`  - Enlace ${index}: "${text}"`);
            }
          });
        }
      } else {
        console.log('‚ùå [COMPLETE FLOW] Error al enviar email:', errorMessage);
      }
    } else {
      console.log('‚ùå [COMPLETE FLOW] Formulario de forgot-password no encontrado');
    }
    
    // Paso 5: Probar flujo alternativo - ir a /reset-password directamente
    console.log('üîç [COMPLETE FLOW] Probando flujo alternativo - /reset-password...');
    await page.goto('http://localhost:3000/reset-password');
    await page.waitForLoadState('networkidle');
    
    const resetPageTitle = await page.locator('h1').textContent();
    console.log('üîç [COMPLETE FLOW] T√≠tulo de reset-password:', resetPageTitle);
    
    // Buscar formulario en reset-password
    const resetPasswordInputs = await page.locator('input[type="password"]').count();
    const resetForms = await page.locator('form').count();
    
    console.log('üîç [COMPLETE FLOW] Elementos en reset-password:');
    console.log('  - Campos de contrase√±a:', resetPasswordInputs);
    console.log('  - Formularios:', resetForms);
    
    if (resetPasswordInputs > 0) {
      console.log('‚úÖ [COMPLETE FLOW] Formulario de reset-password encontrado');
      
      // Buscar campos espec√≠ficos
      const tokenField = page.locator('input[name="token"]');
      const newPasswordField = page.locator('input[name="newPassword"]');
      const confirmPasswordField = page.locator('input[name="confirmPassword"]');
      
      const tokenExists = await tokenField.count();
      const newPasswordExists = await newPasswordField.count();
      const confirmPasswordExists = await confirmPasswordField.count();
      
      console.log('üîç [COMPLETE FLOW] Campos en reset-password:');
      console.log('  - Token:', tokenExists);
      console.log('  - Nueva contrase√±a:', newPasswordExists);
      console.log('  - Confirmar contrase√±a:', confirmPasswordExists);
      
      if (tokenExists > 0 && newPasswordExists > 0 && confirmPasswordExists > 0) {
        // Llenar formulario con token simulado
        await tokenField.fill('simulated-token-123');
        await newPasswordField.fill('nueva123456');
        await confirmPasswordField.fill('nueva123456');
        
        console.log('üîç [COMPLETE FLOW] Formulario de reset llenado');
        
        // Enviar formulario
        const submitButton = page.locator('button[type="submit"]');
        await submitButton.click();
        
        console.log('üîç [COMPLETE FLOW] Formulario de reset enviado');
        
        // Esperar respuesta
        await page.waitForTimeout(3000);
        
        // Verificar resultado
        const resetSuccessMessage = await page.locator('.text-green-400').textContent();
        const resetErrorMessage = await page.locator('.text-red-400').textContent();
        
        console.log('üîç [COMPLETE FLOW] Resultado de reset:');
        console.log('  - Mensaje de √©xito:', resetSuccessMessage);
        console.log('  - Mensaje de error:', resetErrorMessage);
        
        // Verificar si hay error de token
        if (resetErrorMessage && (resetErrorMessage.includes('token') || resetErrorMessage.includes('inv√°lido') || resetErrorMessage.includes('expirado'))) {
          console.log('‚ùå [COMPLETE FLOW] ERROR DE TOKEN EN RESET:', resetErrorMessage);
        } else if (resetSuccessMessage) {
          console.log('‚úÖ [COMPLETE FLOW] RESET DE CONTRASE√ëA EXITOSO:', resetSuccessMessage);
        }
      }
    }
    
    // Paso 6: Generar reporte final
    const report = {
      timestamp: new Date().toISOString(),
      testName: 'Complete Password Change Flow',
      credentials: {
        email: 'jose1@gmail.com',
        password: '123456789'
      },
      results: {
        forgotPasswordPageAccessible: pageTitle === '¬øOlvidaste tu contrase√±a?',
        forgotPasswordFormFound: emailInputs > 0 && submitButtons > 0,
        emailSentSuccessfully: successMessage || checkCircle > 0,
        resetPasswordPageAccessible: resetPageTitle === 'Reset Password' || resetPageTitle === 'Restablecer Contrase√±a',
        resetPasswordFormFound: resetPasswordInputs > 0,
        networkErrors: networkErrors
      },
      consoleLogs: consoleLogs.filter(log => 
        log.includes('password') || 
        log.includes('token') || 
        log.includes('error') || 
        log.includes('success') ||
        log.includes('jose') ||
        log.includes('forgot') ||
        log.includes('reset')
      )
    };
    
    console.log('üìä [COMPLETE FLOW] REPORTE FINAL:');
    console.log(JSON.stringify(report, null, 2));
    
    // Guardar reporte
    await page.evaluate((report) => {
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'complete-password-flow-test-report.json';
      a.click();
      URL.revokeObjectURL(url);
    }, report);
    
    console.log('üéØ [COMPLETE FLOW] Test completado');
  });
});
